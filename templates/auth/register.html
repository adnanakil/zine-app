{% extends "base.html" %}

{% block title %}Sign Up - Zines{% endblock %}

{% block extra_css %}
<style>
    .social-login-btn {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: background 0.3s;
    }
    .social-login-btn:hover {
        background: #f5f5f5;
    }
    .divider {
        text-align: center;
        margin: 20px 0;
        position: relative;
    }
    .divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #ddd;
    }
    .divider span {
        background: white;
        padding: 0 10px;
        position: relative;
    }
    #authError {
        background: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 5px;
        margin-bottom: 20px;
        display: none;
    }
    .username-check {
        font-size: 12px;
        margin-top: 5px;
    }
    .username-check.available {
        color: #28a745;
    }
    .username-check.taken {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-container">
    <h2>Create Your Account</h2>

    <div id="authError"></div>

    <button class="social-login-btn" onclick="signInWithGoogle()">
        <svg width="20" height="20" viewBox="0 0 48 48">
            <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/>
            <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/>
            <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/>
            <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/>
        </svg>
        Sign up with Google
    </button>

    <div class="divider">
        <span>OR</span>
    </div>

    <form id="registerForm">
        <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required pattern="[a-zA-Z0-9_]+" maxlength="20" minlength="3" title="Letters, numbers, and underscores only">
            <div id="usernameCheck" class="username-check"></div>
        </div>
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" required>
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required minlength="6">
        </div>
        <button type="submit" class="btn-primary" style="width: 100%;">Create Account</button>
    </form>

    <p style="text-align: center; margin-top: 20px;">
        Already have an account? <a href="/auth/login">Sign in</a>
    </p>
</div>

<script>
    // Firebase config from backend
    const firebaseConfig = {{ firebase_config | tojson }};
</script>
<script src="{{ url_for('static', filename='js/firebase-auth.js') }}"></script>
<script>
    // Initialize Firebase on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeFirebase(firebaseConfig);

        // Check username availability
        let checkTimeout;
        const usernameInput = document.getElementById('username');
        const usernameCheck = document.getElementById('usernameCheck');

        usernameInput.addEventListener('input', function() {
            clearTimeout(checkTimeout);
            const username = this.value.trim();

            if (username.length < 3) {
                usernameCheck.textContent = 'Username must be at least 3 characters';
                usernameCheck.className = 'username-check taken';
                return;
            }

            usernameCheck.textContent = 'Checking...';
            usernameCheck.className = 'username-check';

            checkTimeout = setTimeout(async () => {
                const response = await fetch('/auth/check-username', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();
                if (data.available) {
                    usernameCheck.textContent = 'âœ“ Username available';
                    usernameCheck.className = 'username-check available';
                } else {
                    usernameCheck.textContent = data.error || 'Username taken';
                    usernameCheck.className = 'username-check taken';
                }
            }, 500);
        });

        // Handle registration form submission
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            // First check if username is available
            const checkResponse = await fetch('/auth/check-username', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username })
            });

            const checkData = await checkResponse.json();
            if (!checkData.available) {
                showError(checkData.error || 'Username is not available');
                return;
            }

            // Create Firebase account
            await signUpWithEmail(email, password, username);
        });
    });
</script>
{% endblock %}