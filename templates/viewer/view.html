{% extends "base.html" %}

{% block title %}{{ zine.title }} by {{ creator.username }} - Zines{% endblock %}

{% block extra_css %}
<style>
    .viewer-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
    }
    .viewer-header {
        text-align: center;
        margin-bottom: 30px;
    }
    .viewer-controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
    }
    .page-viewer {
        background: white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin: 0 auto;
        position: relative;
    }
    .page-viewer.A5 {
        width: 420px;
        min-height: 594px;
    }
    .page-viewer.A4 {
        width: 595px;
        min-height: 842px;
    }
    .page-viewer.square {
        width: 500px;
        min-height: 500px;
    }
    .page-content {
        position: relative;
        width: 100%;
        height: 100%;
        padding: 20px;
    }
    .page-element {
        position: absolute;
    }
    .page-element.text {
        padding: 10px;
    }
    .page-element.image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .flip-container {
        perspective: 1000px;
        margin: 0 auto;
    }
    .flip-book {
        transition: transform 0.6s;
        transform-style: preserve-3d;
    }
    .flip-book.flipped {
        transform: rotateY(180deg);
    }
    .attribution {
        text-align: center;
        margin-top: 40px;
        padding: 20px;
        background: #f5f5f5;
        border-radius: 8px;
    }
    .qr-code {
        margin: 20px auto;
        text-align: center;
    }
    .qr-code img {
        width: 150px;
        height: 150px;
    }
    .mode-toggle {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 20px;
    }
    .scroll-mode .page-viewer {
        margin-bottom: 20px;
    }
    .flip-mode .page-viewer {
        display: none;
    }
    .flip-mode .page-viewer.current {
        display: block;
    }
    .page-navigation {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin: 20px 0;
    }
    .creator-info {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
    }
    .creator-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #ddd;
    }
</style>
{% endblock %}

{% block content %}
<div class="viewer-container">
    <div class="viewer-header">
        <h1>{{ zine.title }}</h1>
        {% if zine.description %}
            <p>{{ zine.description }}</p>
        {% endif %}

        <div class="creator-info">
            {% if creator.avatar_url %}
                <img src="{{ creator.avatar_url }}" alt="{{ creator.username }}" class="creator-avatar">
            {% else %}
                <div class="creator-avatar"></div>
            {% endif %}
            <div>
                <a href="/{{ creator.username }}">{{ creator.username }}</a>
                {% if current_user.is_authenticated and current_user.id != creator.id %}
                    {% if is_following %}
                        <a href="/unfollow/{{ creator.id }}" class="btn-secondary btn-sm">Unfollow</a>
                    {% else %}
                        <a href="/follow/{{ creator.id }}" class="btn-primary btn-sm">Follow</a>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="mode-toggle">
        <button id="scrollModeBtn" class="btn-secondary active">Scroll</button>
        <button id="flipModeBtn" class="btn-secondary">Flip</button>
        {% if zine.enable_pdf %}
            <a href="/{{ creator.username }}/{{ zine.slug }}/pdf" class="btn-secondary">Download PDF</a>
        {% endif %}
    </div>

    <div id="viewerContent" class="scroll-mode">
        {% for page in pages %}
        <div class="page-viewer {{ zine.layout_type }}" data-page="{{ loop.index }}">
            <div class="page-content">
                {% if page.content and page.content.blocks %}
                    {% for block in page.content.blocks %}
                        <div class="page-element {{ block.type }}"
                             style="left: {{ block.x }}; top: {{ block.y }};
                                    width: {{ block.width }}; height: {{ block.height }};
                                    {% if block.style %}
                                        font-size: {{ block.style.fontSize }};
                                        color: {{ block.style.color }};
                                        background: {{ block.style.background }};
                                        border-radius: {{ block.style.borderRadius }};
                                    {% endif %}">
                            {% if block.type == 'text' %}
                                {{ block.content }}
                            {% elif block.type == 'image' and block.src %}
                                <img src="{{ block.src }}" alt="">
                            {% elif block.type == 'shape' %}
                                <div style="width: 100%; height: 100%; background: {{ block.style.background }}; border-radius: {{ block.style.borderRadius }};"></div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="page-navigation" style="display: none;">
        <button id="prevPageBtn" class="btn-secondary">← Previous</button>
        <span id="pageIndicator">Page 1 of {{ pages|length }}</span>
        <button id="nextPageBtn" class="btn-secondary">Next →</button>
    </div>

    <div class="attribution">
        <h3>Share this zine</h3>
        <div class="qr-code">
            <img src="data:image/png;base64,{{ qr_code }}" alt="QR Code">
        </div>
        <p>{{ request.url }}</p>

        {% if current_user.is_authenticated and current_user.id != creator.id %}
            {% if is_following %}
                <p>You're following {{ creator.username }}</p>
            {% else %}
                <a href="/follow/{{ creator.id }}" class="btn-primary">Follow {{ creator.username }}</a>
            {% endif %}
        {% endif %}

        <div class="share-buttons">
            <button onclick="navigator.share({title: '{{ zine.title }}', url: '{{ request.url }}'})" class="btn-secondary">Share</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentMode = 'scroll';
let currentPage = 1;
const totalPages = {{ pages|length }};
let readStartTime = Date.now();

const viewerContent = document.getElementById('viewerContent');
const pageNav = document.querySelector('.page-navigation');
const pageIndicator = document.getElementById('pageIndicator');

document.getElementById('scrollModeBtn').addEventListener('click', () => {
    currentMode = 'scroll';
    viewerContent.className = 'scroll-mode';
    pageNav.style.display = 'none';
    document.getElementById('scrollModeBtn').classList.add('active');
    document.getElementById('flipModeBtn').classList.remove('active');
    showAllPages();
});

document.getElementById('flipModeBtn').addEventListener('click', () => {
    currentMode = 'flip';
    viewerContent.className = 'flip-mode';
    pageNav.style.display = 'flex';
    document.getElementById('flipModeBtn').classList.add('active');
    document.getElementById('scrollModeBtn').classList.remove('active');
    showPage(1);
});

document.getElementById('prevPageBtn').addEventListener('click', () => {
    if (currentPage > 1) {
        showPage(currentPage - 1);
    }
});

document.getElementById('nextPageBtn').addEventListener('click', () => {
    if (currentPage < totalPages) {
        showPage(currentPage + 1);
    }
});

function showPage(pageNum) {
    currentPage = pageNum;
    document.querySelectorAll('.page-viewer').forEach(page => {
        page.classList.remove('current');
    });
    const targetPage = document.querySelector(`.page-viewer[data-page="${pageNum}"]`);
    if (targetPage) {
        targetPage.classList.add('current');
    }
    pageIndicator.textContent = `Page ${pageNum} of ${totalPages}`;

    document.getElementById('prevPageBtn').disabled = pageNum === 1;
    document.getElementById('nextPageBtn').disabled = pageNum === totalPages;
}

function showAllPages() {
    document.querySelectorAll('.page-viewer').forEach(page => {
        page.classList.remove('current');
    });
}

window.addEventListener('beforeunload', () => {
    const readTime = (Date.now() - readStartTime) / 1000;
    fetch('/api/track-read-time', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            zine_id: {{ zine.id }},
            read_time: readTime
        })
    });
});

document.addEventListener('keydown', (e) => {
    if (currentMode === 'flip') {
        if (e.key === 'ArrowLeft' && currentPage > 1) {
            showPage(currentPage - 1);
        } else if (e.key === 'ArrowRight' && currentPage < totalPages) {
            showPage(currentPage + 1);
        }
    }
});
</script>
{% endblock %}